# /etc/init/sidekiq.conf - Sidekiq Upstart config

# Based on:
# https://github.com/mperham/sidekiq/wiki/Deploying-to-Ubuntu
# https://github.com/mperham/sidekiq/tree/master/examples/upstart

description "Sidekiq Background Worker"

# This starts upon bootup and stops on shutdown
start on runlevel [2345]
stop on runlevel [06]

setuid <%= @user %>
setgid <%= @group %>

respawn
respawn limit 3 30

# TERM is sent by sidekiqctl when stopping sidekiq. Without declaring these as
# normal exit codes, it just respawns.
normal exit 0 TERM

# Older versions of Upstart might not support the reload command and need
# this commented out.
reload signal USR1

<% @environment.each do |key, value| %>
ENV['<%= key %>'] = "<%= value %>"
<% end %>

chdir <%= @app_root %>

# Logs out to /var/log/upstart/sidekiq.log by default

script
  exec bundle exec sidekiq -e production
end script
